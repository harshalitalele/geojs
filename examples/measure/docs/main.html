<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* globals $, geo, utils */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This is extensively based on the Annotation example.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Always positive modulo function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modulo</span>(<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">return</span> ((a % b) + b) % b;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Get url query parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> query = utils.getQuery();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If a flag is set, add some extra tile sources.  Make sure you have the
appropriate licenses before doing this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (query.extra) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>This is a proof of concept; it may require licensing, or at least
registering with Microsoft</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  geo.osmLayer.tileSources[<span class="hljs-string">'bing-satellite'</span>] = {
    <span class="hljs-attr">url</span>: <span class="hljs-function">(<span class="hljs-params">x, y, z, s</span>) =&gt;</span> {
      s = s[modulo(x + y + z, s.length)];
      <span class="hljs-keyword">let</span> tile = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">for</span> (; z &gt; <span class="hljs-number">0</span>; z -= <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">let</span> d = (x % <span class="hljs-number">2</span>) + (y % <span class="hljs-number">2</span>) * <span class="hljs-number">2</span>;
        tile = <span class="hljs-string">''</span> + d + tile;
        x = <span class="hljs-built_in">Math</span>.floor(x / <span class="hljs-number">2</span>);
        y = <span class="hljs-built_in">Math</span>.floor(y / <span class="hljs-number">2</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-string">`http://ecn.t<span class="hljs-subst">${s}</span>.tiles.virtualearth.net/tiles/a<span class="hljs-subst">${tile}</span>.jpeg?g=5000`</span>;
    },
    <span class="hljs-attr">attribution</span>: <span class="hljs-string">'&lt;a href="https://www.microsoft.com/maps/product/terms.html"&gt;Microsoft&lt;/a&gt; Virtual Earth'</span>,
    <span class="hljs-attr">subdomains</span>: <span class="hljs-string">'0123'</span>,
    <span class="hljs-attr">minLevel</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">maxLevel</span>: <span class="hljs-number">19</span>
  };
  $(<span class="hljs-string">'#basemap option[value="custom"]'</span>).before(<span class="hljs-string">'&lt;option value="bing-satellite"&gt;Bing Satellite&lt;/option&gt;'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>This requires that you have an appropriate Esri ArcGIS license to use.  It
is possible that its use might be allowed in certain uses via
<a href="https://www.arcgis.com/home/item.html?id=10df2279f9684e4a9f6a7f08febac2a9">https://www.arcgis.com/home/item.html?id=10df2279f9684e4a9f6a7f08febac2a9</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  geo.osmLayer.tileSources[<span class="hljs-string">'arcgis-satellite'</span>] = {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png'</span>,
    <span class="hljs-attr">attribution</span>: <span class="hljs-string">'&lt;a href="https://www.esri.com/en-us/search/?q=world%20imagery"&gt;Esri World Imagery&lt;/a&gt;'</span>,
    <span class="hljs-attr">minLevel</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">maxLevel</span>: <span class="hljs-number">19</span>
  };
  $(<span class="hljs-string">'#basemap option[value="custom"]'</span>).before(<span class="hljs-string">'&lt;option value="arcgis-satellite"&gt;ArcGIS Satellite&lt;/option&gt;'</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Add a blank tile for removing the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>geo.osmLayer.tileSources[<span class="hljs-string">'false'</span>] = {
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/data/white.jpg'</span>,
  <span class="hljs-attr">attribution</span>: <span class="hljs-string">''</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Define a decimal miles unit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>geo.gui.scaleWidget.unitsTable[<span class="hljs-string">'decmiles'</span>] = [
  {<span class="hljs-attr">unit</span>: <span class="hljs-string">'mi'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1609.344</span>}
];</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Define area units</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> areaUnitsTable = {
  <span class="hljs-attr">si</span>: [
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'nm\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1e-18</span>},
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'\u03BCm\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1e-12</span>},
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'mm\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1e-6</span>},
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'m\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>},
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'km\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1e6</span>}
  ],
  <span class="hljs-attr">hectares</span>: [
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'ha'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1e4</span>}
  ],
  <span class="hljs-attr">decmiles</span>: [
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'mi\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1609.344</span> * <span class="hljs-number">1609.344</span>}
  ],
  <span class="hljs-attr">miles</span>: [
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'in\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">0.0254</span> * <span class="hljs-number">0.0254</span>},
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'ft\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">0.3048</span> * <span class="hljs-number">0.3048</span>},
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'mi\xB2'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1609.344</span> * <span class="hljs-number">1609.344</span>}
  ],
  <span class="hljs-attr">acres</span>: [
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'pl'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">0.3048</span> * <span class="hljs-number">0.3048</span> * <span class="hljs-number">16.5</span> * <span class="hljs-number">16.5</span>},
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'rd'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1609.344</span> * <span class="hljs-number">1609.344</span> / <span class="hljs-number">640</span> / <span class="hljs-number">4</span>},
    {<span class="hljs-attr">unit</span>: <span class="hljs-string">'ac'</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1609.344</span> * <span class="hljs-number">1609.344</span> / <span class="hljs-number">640</span>}
  ]
};

<span class="hljs-keyword">var</span> map, mapLayer, layer, fromButtonSelect, fromGeojsonUpdate;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Set controls based on query parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$(<span class="hljs-string">'#basemap'</span>).val(query.basemap || <span class="hljs-string">'stamen-toner-lite'</span>);
$(<span class="hljs-string">'#mapurl'</span>).val(query.mapurl || <span class="hljs-string">''</span>);
$(<span class="hljs-string">'#mapurl'</span>).toggleClass(<span class="hljs-string">'hidden'</span>, $(<span class="hljs-string">'#basemap'</span>).val() !== <span class="hljs-string">'custom'</span>);
$(<span class="hljs-string">'#distunit'</span>).val(query.distunit || <span class="hljs-string">'decmiles'</span>);
$(<span class="hljs-string">'#areaunit'</span>).val(query.areaunit || <span class="hljs-string">'decmiles'</span>);
$(<span class="hljs-string">'#clickmode'</span>).val(query.clickmode || <span class="hljs-string">'edit'</span>);
$(<span class="hljs-string">'#keepadding'</span>).prop(<span class="hljs-string">'checked'</span>, query.keepadding === <span class="hljs-string">'true'</span>);
$(<span class="hljs-string">'#showLabels'</span>).prop(<span class="hljs-string">'checked'</span>, query.labels !== <span class="hljs-string">'false'</span>);
<span class="hljs-keyword">if</span> (query.lastannotation) {
  $(<span class="hljs-string">'.annotationtype button'</span>).removeClass(<span class="hljs-string">'lastused'</span>);
  $(<span class="hljs-string">'.annotationtype button#'</span> + query.lastannotation).addClass(<span class="hljs-string">'lastused'</span>);
}
<span class="hljs-keyword">if</span> (query.hide) {
  $(<span class="hljs-string">'#controls'</span>).addClass(<span class="hljs-string">'reduced'</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>You can set the intiial annotations via a query parameter.  If the query
parameter ‘save=true’ is specified, the query will be updated with the
geojson.  This can become too long for some browsers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> initialGeoJSON = query.geojson;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>respond to changes in our controls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$(<span class="hljs-string">'#controls'</span>).on(<span class="hljs-string">'change'</span>, change_controls);
$(<span class="hljs-string">'#geojson[type=textarea]'</span>).on(<span class="hljs-string">'input propertychange'</span>, change_geojson);
$(<span class="hljs-string">'#controls'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'a'</span>, select_control);
$(<span class="hljs-string">'.annotationtype button'</span>).on(<span class="hljs-string">'click'</span>, select_annotation);
$(<span class="hljs-string">'#editdialog'</span>).on(<span class="hljs-string">'submit'</span>, edit_update);
$(<span class="hljs-string">'#show,#hide'</span>).on(<span class="hljs-string">'click'</span>, toggle_hide);

$(<span class="hljs-string">'#controls'</span>).toggleClass(<span class="hljs-string">'no-controls'</span>, query.controls === <span class="hljs-string">'false'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Default to near Fresno unless a position is specified.  If there is existing
data, we frame the available data instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>map = geo.map({
  <span class="hljs-attr">node</span>: <span class="hljs-string">'#map'</span>,
  <span class="hljs-attr">center</span>: {
    <span class="hljs-attr">x</span>: query.x !== <span class="hljs-literal">undefined</span> ? +query.x : <span class="hljs-number">-119.150</span>,
    <span class="hljs-attr">y</span>: query.y !== <span class="hljs-literal">undefined</span> ? +query.y : <span class="hljs-number">36.712</span>
  },
  <span class="hljs-attr">max</span>: <span class="hljs-number">21</span>,
  <span class="hljs-attr">zoom</span>: query.zoom ? +query.zoom : <span class="hljs-number">10</span>,
  <span class="hljs-attr">rotation</span>: query.rotation ? +query.rotation * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">180</span> : <span class="hljs-number">0</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create a tile layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>mapLayer = map.createLayer(<span class="hljs-string">'osm'</span>, {
  <span class="hljs-attr">url</span>: query.basemap === <span class="hljs-string">'custom'</span> ? query.mapurl || <span class="hljs-string">''</span> : <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">source</span>: query.basemap === <span class="hljs-string">'custom'</span> ? <span class="hljs-literal">undefined</span> : query.basemap
});</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Create an annotation layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>layer = map.createLayer(<span class="hljs-string">'annotation'</span>, {
  <span class="hljs-attr">renderer</span>: query.renderer ? (query.renderer === <span class="hljs-string">'html'</span> ? <span class="hljs-literal">null</span> : query.renderer) : <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">annotations</span>: query.renderer ? <span class="hljs-literal">undefined</span> : geo.listAnnotations(),
  <span class="hljs-attr">showLabels</span>: query.labels === <span class="hljs-string">'false'</span> ? <span class="hljs-literal">false</span> : <span class="hljs-built_in">Object</span>.keys(geo.annotation.state),
  <span class="hljs-attr">clickToEdit</span>: !query.clickmode || query.clickmode === <span class="hljs-string">'edit'</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>We have to hook the internal _updateLabels method so we can label vertices
during editing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> s__updateLabels = layer._updateLabels;
layer._updateLabels = <span class="hljs-function">(<span class="hljs-params">labels</span>) =&gt;</span> {
  layer.annotations().forEach(<span class="hljs-function">(<span class="hljs-params">annotation, idx</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> ([geo.annotation.state.create, geo.annotation.state.edit].indexOf(annotation.state()) &gt;= <span class="hljs-number">0</span>) {
      labelVertices(annotation, idx, labels);
    }
  });
  s__updateLabels(labels);
  <span class="hljs-keyword">return</span> layer;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Bind to the mouse click and annotation mode events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>layer.geoOn(geo.event.mouseclick, mouseClickToStart);
layer.geoOn(geo.event.annotation.mode, handleModeChange);
layer.geoOn(geo.event.annotation.add, handleAnnotationChange);
layer.geoOn(geo.event.annotation.update, handleAnnotationChange);
layer.geoOn(geo.event.annotation.remove, handleAnnotationChange);
layer.geoOn(geo.event.annotation.state, handleAnnotationChange);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Add a scale widget</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> uiLayer = map.createLayer(<span class="hljs-string">'ui'</span>);
<span class="hljs-keyword">var</span> scaleWidget = uiLayer.createWidget(<span class="hljs-string">'scale'</span>, {
  <span class="hljs-attr">position</span>: {<span class="hljs-attr">right</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span>},
  <span class="hljs-attr">units</span>: query.distunit === <span class="hljs-string">'si'</span> ? <span class="hljs-string">'si'</span> : <span class="hljs-string">'miles'</span>
});

map.draw();</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Pick which button is initially highlighted based on query parameters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (query.lastused || query.active) {
  <span class="hljs-keyword">if</span> (query.active) {
    layer.mode(query.active);
  } <span class="hljs-keyword">else</span> {
    $(<span class="hljs-string">'.annotationtype button'</span>).removeClass(<span class="hljs-string">'lastused active'</span>);
    $(<span class="hljs-string">'.annotationtype button#'</span> + query.lastused).addClass(<span class="hljs-string">'lastused'</span>);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If we have geojson as a query parameter, populate our annotations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (initialGeoJSON) {
  layer.geojson(initialGeoJSON, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">if</span> (query.x === <span class="hljs-literal">undefined</span> || query.y === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">let</span> range = {};
    layer.annotations().forEach(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> {
      a.coordinates().forEach(<span class="hljs-function"><span class="hljs-params">pt</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (range.left === <span class="hljs-literal">undefined</span> || pt.x &lt; range.left) {
          range.left = pt.x;
        }
        <span class="hljs-keyword">if</span> (range.bottom === <span class="hljs-literal">undefined</span> || pt.y &lt; range.bottom) {
          range.bottom = pt.y;
        }
        <span class="hljs-keyword">if</span> (range.right === <span class="hljs-literal">undefined</span> || pt.x &gt; range.right) {
          range.right = pt.x;
        }
        <span class="hljs-keyword">if</span> (range.top === <span class="hljs-literal">undefined</span> || pt.y &gt; range.top) {
          range.top = pt.y;
        }
      });
    });
    map.bounds(range);
    map.zoom(map.zoom() - <span class="hljs-number">0.25</span>);
  }
}

<span class="hljs-comment">/**
 * When the mouse is clicked, switch to adding an annotation if appropriate.
 *
 * @param {geo.event} evt geojs event.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouseClickToStart</span>(<span class="hljs-params">evt</span>) </span>{
  <span class="hljs-keyword">if</span> (evt.handled || query.clickmode !== <span class="hljs-string">'add'</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (evt.buttonsDown.left) {
    <span class="hljs-keyword">if</span> ($(<span class="hljs-string">'.annotationtype button.lastused'</span>).hasClass(<span class="hljs-string">'active'</span>) &amp;&amp; query.keepadding === <span class="hljs-string">'true'</span>) {
      <span class="hljs-keyword">return</span>;
    }
    select_button(<span class="hljs-string">'.annotationtype button.lastused'</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (evt.buttonsDown.right) {
    select_button(<span class="hljs-string">'.annotationtype button#'</span> +
                  $(<span class="hljs-string">'.annotationtype button.lastused'</span>).attr(<span class="hljs-string">'next'</span>));
  }
}

<span class="hljs-comment">/**
 * Handle changes to our controls.
 *
 * @param evt jquery evt that triggered this call.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">change_controls</span>(<span class="hljs-params">evt</span>) </span>{
  <span class="hljs-keyword">var</span> ctl = $(evt.target),
      param = ctl.attr(<span class="hljs-string">'param-name'</span>),
      value = ctl.val();
  <span class="hljs-keyword">if</span> (ctl.is(<span class="hljs-string">'[type="checkbox"]'</span>)) {
    value = ctl.is(<span class="hljs-string">':checked'</span>) ? <span class="hljs-string">'true'</span> : <span class="hljs-string">'false'</span>;
  }
  <span class="hljs-keyword">if</span> (value === <span class="hljs-string">''</span> &amp;&amp; ctl.attr(<span class="hljs-string">'placeholder'</span>)) {
    value = ctl.attr(<span class="hljs-string">'placeholder'</span>);
  }
  <span class="hljs-keyword">if</span> (!param || value === query[param]) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">switch</span> (param) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'basemap'</span>:
      <span class="hljs-keyword">if</span> (value === <span class="hljs-string">'custom'</span>) {
        mapLayer.url(query.mapurl || <span class="hljs-string">''</span>).attribution(<span class="hljs-string">''</span>).draw();
      } <span class="hljs-keyword">else</span> {
        mapLayer.source(value).draw();
      }
      $(<span class="hljs-string">'#mapurl'</span>).toggleClass(<span class="hljs-string">'hidden'</span>, value !== <span class="hljs-string">'custom'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'mapurl'</span>:
      <span class="hljs-keyword">if</span> (query.basemap === <span class="hljs-string">'custom'</span>) {
        mapLayer.url(value || <span class="hljs-string">''</span>).attribution(<span class="hljs-string">''</span>).draw();
      }
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'distunit'</span>:
      query[param] = value;
      layer.annotations().forEach(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.modified());
      layer.draw();
      handleAnnotationChange();
      scaleWidget.options(<span class="hljs-string">'units'</span>, query.distunit === <span class="hljs-string">'si'</span> ? <span class="hljs-string">'si'</span> : <span class="hljs-string">'miles'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'areaunit'</span>:
      query[param] = value;
      layer.annotations().forEach(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.modified());
      layer.draw();
      handleAnnotationChange();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'labels'</span>:
      layer.options(<span class="hljs-string">'showLabels'</span>, value === <span class="hljs-string">'false'</span> ? <span class="hljs-literal">false</span> : <span class="hljs-built_in">Object</span>.keys(geo.annotation.state));
      layer.draw();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'clickmode'</span>:
      layer.options(<span class="hljs-string">'clickToEdit'</span>, value === <span class="hljs-string">'edit'</span>);
      layer.draw();
      <span class="hljs-keyword">break</span>;
  }
  query[param] = value;
  <span class="hljs-keyword">if</span> (value === <span class="hljs-string">''</span> || (ctl.attr(<span class="hljs-string">'placeholder'</span>) &amp;&amp;
      value === ctl.attr(<span class="hljs-string">'placeholder'</span>))) {
    <span class="hljs-keyword">delete</span> query[param];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Update our query parameters, os when you reload the page it is in the
same state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  utils.setQuery(query);
}

<span class="hljs-comment">/**
 * Toggle showing the full controls.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toggle_hide</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (query.hide) {
    <span class="hljs-keyword">delete</span> query.hide;
  } <span class="hljs-keyword">else</span> {
    query.hide = <span class="hljs-string">'true'</span>;
  }
  $(<span class="hljs-string">'#controls'</span>).toggleClass(<span class="hljs-string">'reduced'</span>, query.hide);
  utils.setQuery(query);
}

<span class="hljs-comment">/**
 * Handle changes to the geojson.
 *
 * @param evt jquery evt that triggered this call.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">change_geojson</span>(<span class="hljs-params">evt</span>) </span>{
  <span class="hljs-keyword">var</span> ctl = $(evt.target),
      value = ctl.val();</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>When we update the geojson from the textarea control, raise a flag so we
(a) ignore bad geojson, and (b) don’t replace the user’s geojson with
the auto-generated geojson</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fromGeojsonUpdate = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> result = layer.geojson(value, <span class="hljs-string">'update'</span>);
  <span class="hljs-keyword">if</span> (query.save !== <span class="hljs-string">'false'</span> &amp;&amp; result !== <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">var</span> geojson = layer.geojson();
    query.geojson = geojson ? <span class="hljs-built_in">JSON</span>.stringify(geojson) : <span class="hljs-literal">undefined</span>;
    utils.setQuery(query);
  }
  fromGeojsonUpdate = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * Handle selecting an annotation button.
 *
 * @param evt jquery evt that triggered this call.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">select_annotation</span>(<span class="hljs-params">evt</span>) </span>{
  select_button(evt.target);
}

<span class="hljs-comment">/**
 * Select an annotation button by jquery selector.
 *
 * @param {object} ctl a jquery selector or element.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">select_button</span>(<span class="hljs-params">ctl</span>) </span>{
  ctl = $(ctl);
  <span class="hljs-keyword">var</span> wasactive = ctl.hasClass(<span class="hljs-string">'active'</span>),
      id = ctl.attr(<span class="hljs-string">'id'</span>);
  fromButtonSelect = <span class="hljs-literal">true</span>;
  layer.mode(wasactive ? <span class="hljs-literal">null</span> : id);
  fromButtonSelect = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * When the annotation mode changes, update the controls to reflect it.
 *
 * @param {geo.event} evt a geojs mode change event.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleModeChange</span>(<span class="hljs-params">evt</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Highlight the current buttons based on the current mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> mode = layer.mode();
  $(<span class="hljs-string">'.annotationtype button'</span>).removeClass(<span class="hljs-string">'active'</span>);
  <span class="hljs-keyword">if</span> (mode) {
    $(<span class="hljs-string">'.annotationtype button'</span>).removeClass(<span class="hljs-string">'lastused active'</span>);
    $(<span class="hljs-string">'.annotationtype button#'</span> + mode).addClass(<span class="hljs-string">'lastused active'</span>);
  }
  $(<span class="hljs-string">'#instructions'</span>).attr(
    <span class="hljs-string">'annotation'</span>, $(<span class="hljs-string">'.annotationtype button.active'</span>).attr(<span class="hljs-string">'id'</span>) || <span class="hljs-string">'none'</span>);
  query.active = $(<span class="hljs-string">'.annotationtype button.active'</span>).attr(<span class="hljs-string">'id'</span>) || <span class="hljs-literal">undefined</span>;
  query.lastused = query.active ? <span class="hljs-literal">undefined</span> : $(<span class="hljs-string">'.annotationtype button.lastused'</span>).attr(<span class="hljs-string">'id'</span>);
  utils.setQuery(query);</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If we are in keep-adding mode, and the mode changed to null, and that
wasn’t caused by clicking the button, reenable the annotation mode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!mode &amp;&amp; !fromButtonSelect &amp;&amp; query.keepadding === <span class="hljs-string">'true'</span>) {
    layer.mode($(<span class="hljs-string">'.annotationtype button.lastused'</span>).attr(<span class="hljs-string">'id'</span>));
  }
}

<span class="hljs-comment">/**
 * Calculate the length of an annotation.
 *
 * @param {geo.annotation} annotation The annotation.
 * @returns {number} The length in meters or `undefined`.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">annotationLength</span>(<span class="hljs-params">annotation</span>) </span>{
  <span class="hljs-keyword">let</span> dist = <span class="hljs-number">0</span>,
      gcs = annotation.layer().map().ingcs(),
      pts = annotation.coordinates(gcs);
  <span class="hljs-keyword">if</span> (pts.length &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">'polygon'</span>, <span class="hljs-string">'rectangle'</span>].indexOf(annotation.type()) &gt;= <span class="hljs-number">0</span>) {
    pts = pts.slice();
    pts.push(pts[<span class="hljs-number">0</span>]);
  }
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pts.length - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">let</span> partial = geo.transform.vincentyDistance(pts[i], pts[i + <span class="hljs-number">1</span>], gcs);
    <span class="hljs-keyword">if</span> (partial) {
      dist += partial.distance;
    }
  }
  <span class="hljs-keyword">return</span> dist;
}

<span class="hljs-comment">/**
 * Calculate the area of an annotation.  Use an equal-area projection centered
 * on the first vertex and then a simple 2-D polygon area calculation.
 *
 * @param {geo.annotation} annotation The annotation.
 * @returns {number} The area in square meters or `undefined`.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">annotationArea</span>(<span class="hljs-params">annotation</span>) </span>{
  <span class="hljs-keyword">let</span> area = <span class="hljs-number">0</span>,
      pts = annotation.coordinates(<span class="hljs-string">'EPSG:4326'</span>);
  <span class="hljs-keyword">if</span> (pts.length &lt; <span class="hljs-number">3</span> || [<span class="hljs-string">'polygon'</span>, <span class="hljs-string">'rectangle'</span>].indexOf(annotation.type()) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>By using an equal-area projection centered at one of the vertices, the
area calculation can be done with a simple formula.  For polygons with
long edges, this won’t be accurate, however.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">let</span> gcs = <span class="hljs-string">`+proj=laea +lat_0=<span class="hljs-subst">${pts[<span class="hljs-number">0</span>].y}</span> +lon_0=<span class="hljs-subst">${pts[<span class="hljs-number">0</span>].x}</span> +x_0=0 +y_0=0 +a=6371007.181 +b=6371007.181 +units=m +no_defs`</span>;
  pts = annotation.coordinates(gcs).slice();
  pts.push(pts[<span class="hljs-number">0</span>]);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pts.length - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
    area += (pts[i + <span class="hljs-number">1</span>].y - pts[i].y) * (pts[i + <span class="hljs-number">1</span>].x + pts[i].x) / <span class="hljs-number">2</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.abs(area);
}

<span class="hljs-comment">/**
 * Format a unit with at least three siginfiicant figures.
 *
 * @param {number} val The value.  A valance or area in base units.
 * @param {string} unit The name of the unit system.
 * @param {object[]} [table] The table of the unit system.
 * @returns {string} A formatted string or `undefined`.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatUnit</span>(<span class="hljs-params">val, unit, table</span>) </span>{
  <span class="hljs-keyword">if</span> (val === <span class="hljs-literal">undefined</span> || val === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span>;
  }
  table = table || geo.gui.scaleWidget.unitsTable;
  <span class="hljs-keyword">if</span> (!table || !table[unit]) {
    <span class="hljs-keyword">return</span>;
  }
  unit = table[unit];
  <span class="hljs-keyword">let</span> pos;
  <span class="hljs-keyword">for</span> (pos = <span class="hljs-number">0</span>; pos &lt; unit.length - <span class="hljs-number">1</span>; pos += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (val &lt; unit[pos + <span class="hljs-number">1</span>].scale) {
      <span class="hljs-keyword">break</span>;
    }
  }
  unit = unit[pos];
  val /= unit.scale;
  <span class="hljs-keyword">let</span> digits = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, -<span class="hljs-built_in">Math</span>.ceil(<span class="hljs-built_in">Math</span>.log10(val)) + <span class="hljs-number">3</span>);
  <span class="hljs-keyword">if</span> (digits &gt; <span class="hljs-number">10</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">let</span> result = val.toFixed(digits);
  <span class="hljs-keyword">if</span> (digits) {
    <span class="hljs-keyword">while</span> (result.substr(result.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'0'</span>) {
      result = result.substr(<span class="hljs-number">0</span>, result.length - <span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">if</span> (result.substr(result.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'.'</span>) {
      result = result.substr(<span class="hljs-number">0</span>, result.length - <span class="hljs-number">1</span>);
    }
  }
  <span class="hljs-keyword">return</span> result + <span class="hljs-string">' '</span> + unit.unit;
}

<span class="hljs-comment">/**
 * Add the units to the name of the annotation if appropriate.
 *
 * @param {geo.annotation} annotation The annotation.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modifyAnnotation</span>(<span class="hljs-params">annotation</span>) </span>{
  <span class="hljs-keyword">if</span> (annotation._changed) {
    <span class="hljs-keyword">return</span>;
  }
  annotation._changed = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> s_labelRecord = annotation.labelRecord;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Hook into the labelRecord method to add the distance and area to the label</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  annotation.labelRecord = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    annotation.options(<span class="hljs-string">'showLabel'</span>, query.labels === <span class="hljs-string">'false'</span> ? <span class="hljs-literal">false</span> : <span class="hljs-built_in">Object</span>.keys(geo.annotation.state));
    <span class="hljs-keyword">let</span> dist = annotationLength(annotation),
        area = annotationArea(annotation);
    <span class="hljs-keyword">var</span> result = s_labelRecord();
    <span class="hljs-keyword">if</span> (result) {
      dist = formatUnit(dist, query.distunit || <span class="hljs-string">'decmiles'</span>);
      <span class="hljs-keyword">if</span> (dist) {
        result.text += <span class="hljs-string">' - '</span> + dist;
      }
      area = formatUnit(area, query.areaunit || <span class="hljs-string">'decmiles'</span>, areaUnitsTable);
      <span class="hljs-keyword">if</span> (area) {
        result.text += <span class="hljs-string">' - '</span> + area;
      }
    }
    <span class="hljs-keyword">if</span> (result.text !== annotation._lastResultText) {
      map.scheduleAnimationFrame(handleAnnotationChange);
      annotation._lastResultText = result.text;
    }
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-comment">/**
 * Label all of the vertices and centers of edges of an annotation.
 *
 * @param {geo.annotation} annotation The annotation.
 * @param {number} annotationIndex The position of the annotation.
 * @param {object[]} labels The labels data array to extend.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">labelVertices</span>(<span class="hljs-params">annotation, annotationIndex, labels</span>) </span>{
  <span class="hljs-keyword">let</span> gcs = annotation.layer().map().gcs(),
      pts = annotation.coordinates(gcs).slice();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; pts.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (pts[i].x === pts[i - <span class="hljs-number">1</span>].x &amp;&amp; pts[i].y === pts[i - <span class="hljs-number">1</span>].y) {
      pts.splice(i, <span class="hljs-number">1</span>);
    }
  }
  <span class="hljs-keyword">if</span> (pts.length &lt; <span class="hljs-number">3</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">'polygon'</span>, <span class="hljs-string">'rectangle'</span>].indexOf(annotation.type()) &gt;= <span class="hljs-number">0</span>) {
    pts.push(pts[<span class="hljs-number">0</span>]);
  }
  <span class="hljs-keyword">var</span> style = labels[annotationIndex].style || {};
  <span class="hljs-keyword">var</span> dist = [], tally = [<span class="hljs-number">0</span>];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pts.length - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">let</span> value = geo.transform.vincentyDistance(pts[i], pts[i + <span class="hljs-number">1</span>], gcs);
    dist.push(value ? value.distance : <span class="hljs-number">0</span>);
  }
  dist.forEach(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> {
    tally.push(tally[i] + d);
  });
  pts.forEach(<span class="hljs-function">(<span class="hljs-params">p, i</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (i) {
      labels.push({
        <span class="hljs-attr">text</span>: formatUnit(tally[i], query.distunit || <span class="hljs-string">'decmiles'</span>) || <span class="hljs-string">''</span>,
        <span class="hljs-attr">position</span>: p,
        <span class="hljs-attr">style</span>: <span class="hljs-built_in">Object</span>.assign({}, style, {<span class="hljs-attr">offset</span>: {<span class="hljs-attr">x</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'left'</span>})
      });
    }
    <span class="hljs-keyword">if</span> (i !== pts.length - <span class="hljs-number">1</span>) {
      labels.push({
        <span class="hljs-attr">text</span>: formatUnit(tally[tally.length - <span class="hljs-number">1</span>] - tally[i], query.distunit || <span class="hljs-string">'decmiles'</span>) || <span class="hljs-string">''</span>,
        <span class="hljs-attr">position</span>: p,
        <span class="hljs-attr">style</span>: <span class="hljs-built_in">Object</span>.assign({}, style, {<span class="hljs-attr">offset</span>: {<span class="hljs-attr">x</span>: <span class="hljs-number">-12</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'right'</span>})
      });
      <span class="hljs-keyword">let</span> p1 = {<span class="hljs-attr">x</span>: (pts[i + <span class="hljs-number">1</span>].x + p.x) / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: (pts[i + <span class="hljs-number">1</span>].y + p.y) / <span class="hljs-number">2</span>};
      labels.push({
        <span class="hljs-attr">text</span>: formatUnit(dist[i], query.distunit || <span class="hljs-string">'decmiles'</span>) || <span class="hljs-string">''</span>,
        <span class="hljs-attr">position</span>: p1,
        <span class="hljs-attr">style</span>: <span class="hljs-built_in">Object</span>.assign({}, style, {<span class="hljs-attr">offset</span>: {<span class="hljs-attr">x</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'left'</span>})
      });
    }
  });
}

<span class="hljs-comment">/**
 * When an annotation is created or removed, update our list of annotations.
 *
 * @param {geo.event} evt a geojs mode change event.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleAnnotationChange</span>(<span class="hljs-params">evt</span>) </span>{
  <span class="hljs-keyword">var</span> annotations = layer.annotations();
  <span class="hljs-keyword">var</span> ids = annotations.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">annotation</span>) </span>{
    <span class="hljs-keyword">return</span> annotation.id();
  });
  <span class="hljs-keyword">var</span> present = [];
  $(<span class="hljs-string">'#annotationlist .entry'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> entry = $(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span> (entry.attr(<span class="hljs-string">'id'</span>) === <span class="hljs-string">'sample'</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> id = entry.attr(<span class="hljs-string">'annotation-id'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Remove deleted annotations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ($.inArray(id, ids) &lt; <span class="hljs-number">0</span>) {
      entry.remove();
      <span class="hljs-keyword">return</span>;
    }
    present.push(id);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Update existing elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    entry.find(<span class="hljs-string">'.entry-name'</span>).text(layer.annotationById(id).name());
  });
  <span class="hljs-keyword">let</span> totaldist = <span class="hljs-number">0</span>, totalarea = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Add if new and fully created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.each(ids, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">idx, id</span>) </span>{
    <span class="hljs-keyword">var</span> annotation = layer.annotationById(id);
    <span class="hljs-keyword">let</span> dist = annotationLength(annotation),
        area = annotationArea(annotation);
    <span class="hljs-keyword">if</span> (dist) { totaldist += dist; }
    <span class="hljs-keyword">if</span> (area) { totalarea += area; }
    dist = formatUnit(dist, query.distunit || <span class="hljs-string">'decmiles'</span>) || <span class="hljs-string">''</span>;
    area = formatUnit(area, query.areaunit || <span class="hljs-string">'decmiles'</span>, areaUnitsTable);
    <span class="hljs-keyword">if</span> (area) {
      dist = (dist ? dist + <span class="hljs-string">' - '</span> : <span class="hljs-string">''</span>) + area;
    }
    <span class="hljs-keyword">if</span> ($.inArray(id, present) &gt;= <span class="hljs-number">0</span>) {
      $(<span class="hljs-string">'#annotationlist .entry[annotation-id="'</span> + id + <span class="hljs-string">'"] .entry-dist'</span>).text(dist);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!annotation._changed) {
      modifyAnnotation(annotation);
    }
    <span class="hljs-keyword">if</span> (annotation.state() === geo.annotation.state.create) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> entry = $(<span class="hljs-string">'#annotationlist .entry#sample'</span>).clone();
    entry.attr({<span class="hljs-attr">id</span>: <span class="hljs-string">''</span>, <span class="hljs-string">'annotation-id'</span>: id});
    entry.find(<span class="hljs-string">'.entry-name'</span>).text(annotation.name());
    entry.find(<span class="hljs-string">'.entry-dist'</span>).text(dist);
    $(<span class="hljs-string">'#annotationlist'</span>).append(entry);
  });
  <span class="hljs-keyword">let</span> dist = formatUnit(totaldist || <span class="hljs-literal">undefined</span>, query.distunit || <span class="hljs-string">'decmiles'</span>) || <span class="hljs-string">''</span>;
  <span class="hljs-keyword">let</span> area = formatUnit(totalarea || <span class="hljs-literal">undefined</span>, query.areaunit || <span class="hljs-string">'decmiles'</span>, areaUnitsTable);
  <span class="hljs-keyword">if</span> (area) {
    dist = (dist ? dist + <span class="hljs-string">' - '</span> : <span class="hljs-string">''</span>) + area;
  }
  $(<span class="hljs-string">'#annotationheader .entry-dist'</span>).text(dist);
  $(<span class="hljs-string">'#annotationheader'</span>).toggleClass(<span class="hljs-string">'present'</span>, $(<span class="hljs-string">'#annotationlist .entry'</span>).length &gt; <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (!fromGeojsonUpdate) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Update the geojson textarea</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> geojson = layer.geojson();
    $(<span class="hljs-string">'#geojson'</span>).val(geojson ? <span class="hljs-built_in">JSON</span>.stringify(geojson, <span class="hljs-literal">undefined</span>, <span class="hljs-number">2</span>) : <span class="hljs-string">''</span>);
    <span class="hljs-keyword">if</span> (query.save !== <span class="hljs-string">'false'</span>) {
      query.geojson = geojson ? <span class="hljs-built_in">JSON</span>.stringify(geojson) : <span class="hljs-literal">undefined</span>;
      utils.setQuery(query);
    }
  }
}

<span class="hljs-comment">/**
 * Handle selecting a control.
 *
 * @param evt jquery evt that triggered this call.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">select_control</span>(<span class="hljs-params">evt</span>) </span>{
  <span class="hljs-keyword">var</span> mode,
      ctl = $(evt.target),
      action = ctl.attr(<span class="hljs-string">'action'</span>),
      id = ctl.closest(<span class="hljs-string">'.entry'</span>).attr(<span class="hljs-string">'annotation-id'</span>),
      annotation = layer.annotationById(id);
  <span class="hljs-keyword">switch</span> (action) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'adjust'</span>:
      layer.mode(layer.modes.edit, annotation);
      layer.draw();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'edit'</span>:
      show_edit_dialog(id);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'remove'</span>:
      layer.removeAnnotation(annotation);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'remove-all'</span>:
      fromButtonSelect = <span class="hljs-literal">true</span>;
      mode = layer.mode();
      layer.mode(<span class="hljs-literal">null</span>);
      layer.removeAllAnnotations();
      layer.mode(mode);
      fromButtonSelect = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-comment">/**
 * Show the edit dialog for a particular annotation.
 *
 * @param {number} id the annotation id to edit.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show_edit_dialog</span>(<span class="hljs-params">id</span>) </span>{
  <span class="hljs-keyword">var</span> annotation = layer.annotationById(id),
      type = annotation.type(),
      typeMatch = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'(^| )('</span> + type + <span class="hljs-string">'|all)( |$)'</span>),
      opt = annotation.options(),
      dlg = $(<span class="hljs-string">'#editdialog'</span>);

  $(<span class="hljs-string">'#edit-validation-error'</span>, dlg).text(<span class="hljs-string">''</span>);
  dlg.attr(<span class="hljs-string">'annotation-id'</span>, id);
  dlg.attr(<span class="hljs-string">'annotation-type'</span>, type);
  $(<span class="hljs-string">'[option="name"]'</span>, dlg).val(annotation.name());
  $(<span class="hljs-string">'[option="label"]'</span>, dlg).val(annotation.label(<span class="hljs-literal">undefined</span>, <span class="hljs-literal">true</span>));
  $(<span class="hljs-string">'[option="description"]'</span>, dlg).val(annotation.description());</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Populate each control with the current value of the annotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">'.form-group[annotation-types]'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> ctl = $(<span class="hljs-keyword">this</span>),
        key = $(<span class="hljs-string">'[option]'</span>, ctl).attr(<span class="hljs-string">'option'</span>),
        format = $(<span class="hljs-string">'[option]'</span>, ctl).attr(<span class="hljs-string">'format'</span>),
        value;
    <span class="hljs-keyword">if</span> (!ctl.attr(<span class="hljs-string">'annotation-types'</span>).match(typeMatch)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>If a property doesn’t exist for the current annotation’s type, hide
the control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ctl.hide();
      <span class="hljs-keyword">return</span>;
    }
    ctl.show();
    <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">'[option]'</span>, ctl).attr(<span class="hljs-string">'optiontype'</span>)) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'option'</span>:
        value = opt[key];
        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'showLabel'</span>) {
          value = <span class="hljs-string">''</span> + !!opt.showLabel;
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'label'</span>:
        value = (opt.labelStyle || {})[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        value = opt.style[key];
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">switch</span> (format) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'angle'</span>:
        <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span> &amp;&amp; value !== <span class="hljs-literal">null</span> &amp;&amp; value !== <span class="hljs-string">''</span>) {
          value = <span class="hljs-string">''</span> + +(+value * <span class="hljs-number">180.0</span> / <span class="hljs-built_in">Math</span>.PI).toFixed(<span class="hljs-number">4</span>) + <span class="hljs-string">' deg'</span>;
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'color'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>always show colors as hex values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        value = geo.util.convertColorToHex(value || {<span class="hljs-attr">r</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">g</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">0</span>}, <span class="hljs-string">'needed'</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'coordinate2'</span>:
        <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span> &amp;&amp; value !== <span class="hljs-literal">null</span> &amp;&amp; value !== <span class="hljs-string">''</span>) {
          value = <span class="hljs-string">''</span> + value.x + <span class="hljs-string">', '</span> + value.y;
        }
    }
    <span class="hljs-keyword">if</span> ((value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-string">''</span> || value === <span class="hljs-literal">null</span>) &amp;&amp; $(<span class="hljs-string">'[option]'</span>, ctl).is(<span class="hljs-string">'select'</span>)) {
      value = $(<span class="hljs-string">'[option] option'</span>, ctl).eq(<span class="hljs-number">0</span>).val();
    }
    $(<span class="hljs-string">'[option]'</span>, ctl).val(value === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">''</span> : <span class="hljs-string">''</span> + value);
  });
  dlg.one(<span class="hljs-string">'shown.bs.modal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    $(<span class="hljs-string">'[option="name"]'</span>, dlg).focus();
  });
  dlg.modal();
}

<span class="hljs-comment">/**
 * Update an annotation from values in the edit dialog.
 *
 * @param evt jquery evt that triggered this call.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">edit_update</span>(<span class="hljs-params">evt</span>) </span>{
  evt.preventDefault();
  <span class="hljs-keyword">var</span> dlg = $(<span class="hljs-string">'#editdialog'</span>),
      id = dlg.attr(<span class="hljs-string">'annotation-id'</span>),
      annotation = layer.annotationById(id),
      opt = annotation.options(),
      type = annotation.type(),
      typeMatch = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'(^| )('</span> + type + <span class="hljs-string">'|all)( |$)'</span>),
      newopt = {<span class="hljs-attr">style</span>: {}, <span class="hljs-attr">labelStyle</span>: {}},
      error;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Validate form values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">'.form-group[annotation-types]'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> ctl = $(<span class="hljs-keyword">this</span>),
        key = $(<span class="hljs-string">'[option]'</span>, ctl).attr(<span class="hljs-string">'option'</span>),
        format = $(<span class="hljs-string">'[option]'</span>, ctl).attr(<span class="hljs-string">'format'</span>),
        value, oldvalue;
    <span class="hljs-keyword">if</span> (!ctl.attr(<span class="hljs-string">'annotation-types'</span>).match(typeMatch)) {
      <span class="hljs-keyword">return</span>;
    }
    value = $(<span class="hljs-string">'[option]'</span>, ctl).val();
    <span class="hljs-keyword">switch</span> (format) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'angle'</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^\s*[.0-9eE]+\s*$/</span>.exec(value)) {
          value += <span class="hljs-string">'deg'</span>;
        }
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">switch</span> (key) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'textScaled'</span>:
        <span class="hljs-keyword">if</span> ([<span class="hljs-string">'true'</span>, <span class="hljs-string">'on'</span>, <span class="hljs-string">'yes'</span>].indexOf(value.trim().toLowerCase()) &gt;= <span class="hljs-number">0</span>) {
          value = map.zoom();
        }
        <span class="hljs-keyword">break</span>;
    }
    value = layer.validateAttribute(value, format);
    <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">'[option]'</span>, ctl).attr(<span class="hljs-string">'optiontype'</span>)) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'option'</span>:
        oldvalue = opt[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'label'</span>:
        oldvalue = (opt.labelStyle || {})[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        oldvalue = opt.style[key];
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">if</span> (value === oldvalue || (oldvalue === <span class="hljs-literal">undefined</span> &amp;&amp; value === <span class="hljs-string">''</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>don’t change anything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
      error = $(<span class="hljs-string">'label'</span>, ctl).text() + <span class="hljs-string">' is not a valid value'</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">'[option]'</span>, ctl).attr(<span class="hljs-string">'optiontype'</span>)) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'option'</span>:
          newopt[key] = value;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'label'</span>:
          newopt.labelStyle[key] = value;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          newopt.style[key] = value;
          <span class="hljs-keyword">break</span>;
      }
    }
  });
  <span class="hljs-keyword">if</span> (error) {
    $(<span class="hljs-string">'#edit-validation-error'</span>, dlg).text(error);
    <span class="hljs-keyword">return</span>;
  }
  annotation.name($(<span class="hljs-string">'[option="name"]'</span>, dlg).val());
  annotation.label($(<span class="hljs-string">'[option="label"]'</span>, dlg).val() || <span class="hljs-literal">null</span>);
  annotation.description($(<span class="hljs-string">'[option="description"]'</span>, dlg).val() || <span class="hljs-string">''</span>);
  annotation.options(newopt).draw();

  dlg.modal(<span class="hljs-string">'hide'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Refresh the annotation list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  handleAnnotationChange();
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
